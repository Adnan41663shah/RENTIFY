<% layout("/layouts/boilerplate") %>
<div class="profile-container d-flex vh-100 bg-light">
  <div class="left-panel bg-white shadow p-3 rounded">
    <div class="user-info text-center mb-4 position-relative">
      <!-- Profile Picture -->
      <form action="/upload" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="userId" value="<%= user._id %>" />

        <div class="position-relative profile-icon mx-auto">
          <img
            id="profileImage"
            src="<%= user.profileImage || '/assets/default-profile.png' %>"
            class="rounded-circle"
            style="width: 150px; height: 150px; object-fit: cover"
          />

          <label
            for="imageUpload"
            class="camera-icon rounded-circle bg-white border shadow-sm"
          >
            <i class="bi bi-camera-fill"></i>
          </label>
          <input
            type="file"
            id="imageUpload"
            name="user[profileImage]"
            accept="image/*"
            style="display: none"
            onchange="this.form.submit()"
          />
        </div>
      </form>

      <h4><%= user.username %></h4>
      <p class="text-muted"><%= user.email %></p>
    </div>
    <!-- User Tasks -->
    <div class="user-tasks d-flex flex-column gap-2">
      <button class="btn btn-outline-primary" onclick="loadPage('myListings')">
        My Properties
      </button>
      <button class="btn btn-outline-success" onclick="loadPage('myBookings')">
        My Bookings
      </button>
      <button class="btn btn-outline-warning" onclick="loadPage('wishlist')">
        Wishlist
      </button>
      <button class="btn btn-outline-info" onclick="loadPage('notifications')">
        Notifications
      </button>

      <a href="/logout" class="btn btn-outline-danger mt-3">Logout</a>
    </div>
  </div>

  <div
    class="right-panel flex-grow-1 bg-white shadow p-4 rounded ms-4"
    id="right-panel"
  >
    <div class="profile-hero card border-0 shadow-sm overflow-hidden">
      <div class="hero-bg"></div>
      <div class="hero-content p-4 p-md-5">
        <div class="d-flex flex-column flex-md-row align-items-center gap-3 gap-md-4">
          <div class="rounded-circle border bg-white d-flex align-items-center justify-content-center overflow-hidden" style="width:96px;height:96px;">
            <img src="<%= user.profileImage || '/assets/default-profile.png' %>" alt="<%= user.username %>" style="width:100%;height:100%;object-fit:cover;" />
          </div>
          <div class="text-center text-md-start">
            <h2 class="mb-1 text-white">Hi, <%= user.username %></h2>
            <p class="mb-2 text-white-50">“Collect moments, not things.”</p>
            <div class="profile-divider my-2"></div>
            <div class="d-flex flex-wrap gap-2 small text-white-75">
              <span class="badge rounded-pill bg-light text-dark px-3 py-2">Email: <%= user.email %></span>
              <span class="badge rounded-pill bg-light text-dark px-3 py-2">User Id: <%= String(user._id).slice(-6) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <div class="d-flex align-items-center gap-2 mb-2">
        <h5 class="m-0">Your Dashboard</h5>
        <div class="flex-grow-1 profile-divider"></div>
      </div>
      <p class="text-muted small">Use the actions on the left to view your properties, bookings, and wishlist.</p>

      <div class="row g-3 mt-2">
        <div class="col-12 col-md-4">
          <button class="w-100 text-start stat-card stat-indigo" onclick="loadPage('myBookings')">
            <div class="label">Total Bookings</div>
            <div class="value"><%= typeof bookingsCount !== 'undefined' ? bookingsCount : 0 %></div>
            <div class="hint">Tap to view your bookings</div>
          </button>
        </div>
        <div class="col-12 col-md-4">
          <button class="w-100 text-start stat-card stat-teal" onclick="loadPage('myListings')">
            <div class="label">Total Properties</div>
            <div class="value"><%= typeof listingsCount !== 'undefined' ? listingsCount : 0 %></div>
            <div class="hint">Tap to view your properties</div>
          </button>
        </div>
        <div class="col-12 col-md-4">
          <button class="w-100 text-start stat-card stat-rose" onclick="loadPage('wishlist')">
            <div class="label">Wishlist</div>
            <div class="value"><%= typeof wishlistCount !== 'undefined' ? wishlistCount : 0 %></div>
            <div class="hint">Tap to view your wishlist</div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  rel="stylesheet"
/>

<script>
  function loadPage(page) {
    fetch(`/<%= user._id %>/${page}`)
      .then((response) => response.text())
      .then((html) => {
        document.getElementById("right-panel").innerHTML = html;
      })
      .catch((error) => console.error("Error loading page:", error));
  }

  // Auto-open panel if ?tab=... is provided
  (function () {
    const params = new URLSearchParams(window.location.search);
    const tab = params.get("tab");
    if (tab) {
      loadPage(tab);
    }
  })();
</script>
